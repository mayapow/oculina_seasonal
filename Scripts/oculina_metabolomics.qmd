---
title: "Oculina_Metabolomics"
format: html
editor: visual
---

## Setup

### Load libraries

```{r}
# install packages as needed
library(tidyverse)
library(readr)
library(here)
library(ggplot2)
library(ggpubr)
library(car)
library(rstatix)
library(emmeans)
library(powerjoin)
```

### Read in data

Here is my metadata

```{r}
oc_meta <- read_csv(here("Data", "Metabolomics","oculina_metabolomics_metadata.csv"))
```

This is the data that Ty initially shared with me in July 2025

```{r}
oculina_full <- read_csv(here("Data", "Metabolomics","Oculina_full.csv"))
head(oculina_full)
```

I noticed these issues that did not match my metadata:

The dataset is missing A9-S, did the sample fail or not transfer over?

The dataset is missing SX7-A, did the sample fail or not transfer over?

AX2 and A12 samples are duplicates? I have AX2 bag labeled as A12 in my dataset so I believe this should only be one sample.

There is a duplicate of SX2-A in the dataset and there should only be one. They are labeled as: CuracaoSet2_plate4_SX2-A_20250221104845 and CuracaoSet2_plate4_SX2-A, might just have copied over twice. Although, looking at the actual data, there are different numbers for the different metabolites so I'm not sure.

S16-A and S16S labels are switched (apo vs sym designations and associated metadata are swapped) - which part of the data is actually switched, just the names or the other data? \*\***symbiosis column is swapped, data is correct - MANUALLY EDITING THIS\*\***

There are two S18-A, with the sample names of 03072025_Curacoa_Plate5_S18A and CuracaoSet2_plate4_S18-A. I believe one is supposed to be S18S, do you know which one is which? \***I believe that 03072025_Curacoa_Plate5_S18A is the symbiotic one by sorting several datasets that split evenly apo/sym - Manually editing this\***

Replicate samples that will be helpful checks - just noting this here, no issues with these samples:

SX1 and S1, SX2 and S15, and then AX4 and A15 are duplicate samples from the same coral and I have them both listed in my dataset - will be good to check using these replicates

SO NOW: Looking through data that was shared with me Sept 3rd (to this email: maya.elizabeth.powell\@gmail.com) - BIG raw data

```{r}
superset_raw <- read_csv(here("Data", "Metabolomics","Ty_superset_data_raw.csv"))
```

### Manual edits

```{r}
#manually editing S16-S and -A to have the correct "symbiosis" column values
 oculina_full[oculina_full$sample_id=="S16-S", "symbiosis"] <- "symbiotic"
 oculina_full[oculina_full$sample_id=="S16-A", "symbiosis"] <- "aposymbiotic"
```

```{r}
#manually editing 03072025_Curacoa_Plate5_S18A to be S18-S
oculina_full[oculina_full$sample=="03072025_Curacoa_Plate5_S18A", "sample_id"] <- "S18-S"
oculina_full[oculina_full$sample=="03072025_Curacoa_Plate5_S18A", "symbiosis"] <- "symbiotic"
```

Merging dataframes based on sample_id to see what's missing

```{r}
oculina_raw <- oc_meta %>% power_left_join(oculina_full, by = "sample_id", conflict = coalesce_xy) #84 samples
```

Samples that we don't have data for are:

SX7-A - **I believe this is accidentally labeled as SX2-A - but we sadly can't tell**

Both SX2 and SX7 samples were run on plate 4 and don't have any different metadata, so I cannot tell them apart - I think this means that both SX2-A samples as well as SX7-A need to be removed from the dataset if we want to do colony tracking. But if we just want to separate them as two unidentified apo samples and not ID/compare them by colony, we can just rename since they are both apo

A9-S - the only thing I can think about this is that there's an A9-5 Hawai ªi sample that could be it, but it looks like it's from a totally different plate (QE_0924_Lipid_plate19_KARP_T1_A9-5), so removing for now.

### Remove data as needed and clean up dataframe

```{r}
id_remove <- c("A9-S", "SX7-A", "SX2-A") #removes 4 samples bc SX2-A duplicate
oculina_clean <- oculina_raw %>%
  filter(!sample_id %in% id_remove)

#make sure B and NB really match designations of files
oculina_clean <- oculina_clean %>% 
  mutate(bleaching = case_when(frag_sym == "A" ~ 'B',
                               frag_sym == "S" ~ 'NB',))

#can do this code below to remove x in front of column names - not doing for now just in case but will likely do in the future
#colnames(oculina_clean)<-gsub("x","",colnames(oculina_clean))
```

### Merge with physiology data

```{r}
physio <- read_csv(here("Data", "Nov_2024", "oculina_nov24_physio.csv"))
oculina_final <- oculina_clean %>% power_left_join(physio, by = "sample_id", conflict = coalesce_xy)
```

### Save dataframes

```{r}
#dataframe just metabolomics data no phys data
write.csv(oculina_clean, here("Data", "Metabolomics", "oculina_clean.csv"), row.names = FALSE)

#dataframe with physiolog
write.csv(oculina_final, here("Data", "Metabolomics", "oculina_final.csv"), row.names = FALSE)
```

## Metabolomics initial analysis

### Read in data

```{r}
oculina_final <- read_csv(here("Data", "Metabolomics", "oculina_final.csv"))
```

### Richness

```{r}


```

## Physiology

### Read in data

```{r}
sym_chla <- read_csv(here("Data", "Nov_2024", "oculina_nov24_physio.csv"))
```

info about variables - add notes that are helpful to you!

sa_colony = aposymbiotic/symbiotic original designation of the colony

sa_frag = aposymbiotic/symbiotic designation of the FRAGMENT

ug_chla_cm = micrograms of chlorophyll a per cm2 of surface area

sym_cm2 = symbiont density for cm2 of surface area

chla_pg_sym = picograms of chlorophyll a per symbiont

depth = deep (30ft), shallow (15ft)

### Chlorophyll a

Graph

```{r}
#chlorophyll a
chla_nov_depth_sa_box <- ggplot(sym_chla, aes(x = depth_sa, y=ug_chla_cm, fill = depth_sa))+
  geom_boxplot()+
  geom_jitter(alpha=0.8, width=0.2)+
  theme_classic(base_size = 22)+
  labs(x = "Fragment symbiotic state", y = "Chlorophyll a (ug per cm2)")+
  stat_summary(data = sym_chla, aes(x = depth_sa, y = ug_chla_cm), geom = "text", fun = max, vjust = -0.5, size = 8,
               label = c("a", "a", "b"))+ 
  #EDIT LETTERS FOR EACH GRAPH - MAKE SURE THEY MATCH WITH STATS!!
  #SAME LETTERS = SAME (not sig dif from eachother)
  #DIF LETTERS = SIGNFICANTLY DIFFERENT FROM EACHOTHER
  theme(legend.position = "none")+
  ylim(-0.2,7)+ #ELLA - EDIT Y LIMIT IF IT CUTS OFF LETTERS ON THE TOP
  #MAKE SURE YOU DON'T GET THE WARNING THAT IT REMOVES ANY DATA
  scale_fill_manual(values = c("white","lightyellow","brown")) #ella change the colors here as you'd like
chla_nov_depth_sa_box

ggsave(here("Output", "Nov_2024","chla_nov_depth_sa_box.pdf"), device = "pdf", h = 6, w = 10, chla_nov_depth_sa_box)
```

Stats

```{r}
#anova
chla_frag_aov <- aov(ug_chla_cm ~ depth_sa, data = sym_chla)
summary(chla_frag_aov)
Anova(chla_frag_aov)

#pairwise
chla_emm <- emmeans::emmeans(chla_frag_aov, ~depth_sa)
pairs(chla_emm)
```

### Symbiont density

Graph

```{r}
#symbiont density
sym_nov_depth_sa_box <- ggplot(sym_chla, aes(x = depth_sa, y=sym_cm2, fill = depth_sa))+
  geom_boxplot()+
  geom_jitter(alpha=0.8, width=0.2)+
  theme_classic(base_size = 22)+
  labs(x = "Fragment symbiotic state", y = "Symbiont density (cells per cm2)")+
  theme(legend.position = "none")+
  scale_fill_manual(values = c("white","lightyellow","brown")) #ella change the colors here as you'd like
sym_nov_depth_sa_box

ggsave(here("Output", "Nov_2024","sym_nov_depth_sa_box.pdf"), device = "pdf", h = 6, w = 10, sym_nov_depth_sa_box)
```

Stats

```{r}
#anova
sym_frag_aov <- aov(sym_cm2 ~ depth_sa, data = sym_chla)
summary(sym_frag_aov)
Anova(sym_frag_aov)

#pairwise
sym_emm <- emmeans::emmeans(sym_frag_aov, ~depth_sa)
pairs(sym_emm)
```

### Chlorphyll a per symbiont

Graph

```{r}
#chla per symbiont
chla_sym_nov_depth_sa_box <- ggplot(sym_chla, aes(x = depth_sa, y=chla_pg_sym, fill = depth_sa))+
  geom_boxplot()+
  geom_jitter(alpha=0.8, width=0.2)+
  theme_classic(base_size = 22)+
  labs(x = "Fragment symbiotic state", y = "Chlorophyll a (pg per symbiont cell)")+
  theme(legend.position = "none")+
  scale_fill_manual(values = c("white","lightyellow","brown")) #ella change the colors here as you'd like
chla_sym_nov_depth_sa_box
ggsave(here("Output", "Nov_2024","chla_sym_nov_depth_sa_box.pdf"), device = "pdf", h = 6, w = 10, chla_sym_nov_depth_sa_box)
```

Stats

```{r}
#anova
chla_sym_frag_aov <- aov(chla_pg_sym ~ depth_sa, data = sym_chla)
summary(chla_sym_frag_aov)
Anova(chla_sym_frag_aov)

#pairwise
chla_sym_emm <- emmeans::emmeans(chla_sym_frag_aov, ~depth_sa)
pairs(chla_sym_emm)
```

### Correlation sym density vs chla

```{r}
#linear plot comparing symbiont density vs chlorophyll a across all 3 groups
sym_chla_scatter <- ggplot(sym_chla, aes(x = sym_cm2, y = ug_chla_cm, fill = depth_sa)) +
  geom_point(color='black', shape = 21) +
  scale_fill_manual(values = c("white","lightyellow","brown"))+
  theme_bw(base_size = 22) +
  geom_smooth(aes(x = sym_cm2, y = ug_chla_cm, group = 1),
              method = "lm", se = TRUE, color = "black", linewidth = 1.1) +
  labs(x = "Symbiont density (cells per cm2)", 
       y = "Chlorophyll a (ug per cm2)", 
       fill = "Fragment symbiotic state")
sym_chla_scatter
ggsave(here("Output", "Nov_2024","sym_chla_scatter.pdf"), device = "pdf", h = 6, w = 10, sym_chla_scatter)

##this indicates that we likely need to remove outliers from this data!! more to do!!
```
